#!/bin/sh
#
# Script to setup running Bacula regression tests
#

check_exit_code()
{
   if [ $? != 0 ] ; then
      echo "Bad exit code giving up"
      exit 1 
   fi
}

cwd=`pwd`
if [ $# != 6 ] ; then
   echo "Incorrect number of arguments. Got $#. Need:"
   echo "setup bacula-src email-address --with-DBNAME --with-tcp-wrappers"
   echo " "
   exit 1
fi
if [ ! -d $1 ] ; then
   echo "Arg 1 must be a Bacula release directory."
   echo " "
   exit 1
fi
rm -rf build bin
# Copy new source
echo "Copying source from $1"
cp -rp $1 build
cp scripts/regress-config build
cd build
rm -f Makefile config.cache
# Run Bacula configuration, make, install
./regress-config ${cwd} $2 $3 $4 $5 $6
check_exit_code
# Cleanup any win32 build in source
cd src/win32
make clean
cd ../..
make
check_exit_code
make install
check_exit_code
cp src/tools/testls ../bin
check_exit_code

cd ${cwd}
bin/bacula stop

mkdir -p working
cd bin
echo "Running database creation scripts"
./create_bacula_database bacula
./drop_bacula_tables bacula
./make_bacula_tables
./grant_bacula_privileges bacula
cd ${cwd}
# Start and stop Bacula to ensure conf files are OK
bin/bacula start
bin/bacula stop
#
# Save Bacula default conf files for later use
#
cp -f bin/*.conf scripts
