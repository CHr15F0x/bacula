#!/bin/sh
#
# Shell script to update MySQL tables from version 1.38 to 1.39  
#
echo " "
echo "This script will update a Bacula MySQL database from version 9 to 9"
echo "Depending on the size of your database,"
echo "this script may take several minutes to run."
echo " "
bindir=@SQL_BINDIR@

if $bindir/mysql $* -f <<END-OF-DATA
USE bacula;

ALTER TABLE Media ADD COLUMN MediaTypeId INTEGER UNSIGNED DEFAULT 0 REFERENCES MediaType;
ALTER TABLE Media ADD COLUMN DeviceId INTEGER UNSIGNED DEFAULT 0 REFERENCES Device;
ALTER TABLE Media ADD COLUMN LocationId INTEGER UNSIGNED DEFAULT 0 REFERENCES Location;
ALTER TABLE Media ADD COLUMN RecycleCount INTEGER UNSIGNED DEFAULT 0;
ALTER TABLE Media ADD COLUMN InitialWrite DATETIME DEFAULT 0;
ALTER TABLE Media ADD COLUMN ScratchPoolId INTEGER UNSIGNED DEFAULT 0 REFERENCES Pool;
ALTER TABLE Media ADD COLUMN RecyclePoolId INTEGER UNSIGNED DEFAULT 0 REFERENCES Pool;
ALTER TABLE Media ADD COLUMN Enabled TINYINT DEFAULT 1;

ALTER TABLE JobMedia DROP ADD COLUMN Stripe;

ALTER TABLE Job ADD COLUMN PriorJobId INTEGER UNSIGNED DEFAULT 0 REFERENCES Job;
ALTER TABLE Job ADD COLUMN RealEndTime DATETIME DEFAULT 0;

CREATE TABLE Log (
   JobId INTEGER INTEGER UNSIGNED DEFAULT 0 REFERENCES JobId,
   LogText BLOB NOT NULL,
   INDEX (JobId)
   );

CREATE TABLE Location (
   LocationId INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
   Location TINYBLOB NOT NULL,
   Cost INTEGER DEFAULT 0,
   Enabled TINYINT,
   PRIMARY KEY(LocationId)
   );


DELETE FROM Version;
INSERT INTO Version (VersionId) VALUES (10);

END-OF-DATA
then
   echo "Update of Bacula MySQL tables succeeded."
else
   echo "Update of Bacula MySQL tables failed."
fi
exit 0
