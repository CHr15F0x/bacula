#!/bin/sh
#
# Shell script to update MySQL tables from version 1.38 to 1.39  
#
echo " "
echo "This script will update a Bacula MySQL database from version 9 to 9"
echo "Depending on the size of your database,"
echo "this script may take several minutes to run."
echo " "
bindir=@SQL_BINDIR@

if $bindir/mysql $* -f <<END-OF-DATA
USE bacula;

ALTER TABLE Media ADD COLUMN MediaTypeId INTEGER UNSIGNED DEFAULT 0 REFERENCES MediaType;
ALTER TABLE Media ADD COLUMN DeviceId INTEGER UNSIGNED DEFAULT 0 REFERENCES Device;
ALTER TABLE Media ADD COLUMN LocationId INTEGER UNSIGNED DEFAULT 0 REFERENCES Location;


CREATE TABLE MAC (
   JobId INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
   OriginalJobId INTEGER UNSIGNED NOT NULL,
   JobType BINARY(1) NOT NULL,
   JobLevel BINARY(1) NOT NULL,
   SchedTime DATETIME NOT NULL,
   StartTime DATETIME NOT NULL,
   EndTime DATETIME NOT NULL,
   JobTDate BIGINT UNSIGNED NOT NULL,
   PRIMARY KEY(JobId)
   );

CREATE TABLE Location (
   LocationId INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
   Location TINYBLOB NOT NULL,
   PRIMARY KEY(LocationId)
   );


DELETE FROM Version;
INSERT INTO Version (VersionId) VALUES (9);

END-OF-DATA
then
   echo "Update of Bacula MySQL tables succeeded."
else
   echo "Update of Bacula MySQL tables failed."
fi
exit 0
