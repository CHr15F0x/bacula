#!/bin/sh
#
# Shell script to update PostgreSQL tables from version 1.38 to 1.39
#
echo " "
echo "This script will update a Bacula PostgreSQL database from version 9 to 9"
echo "Depending on the size of your database,"
echo "this script may take several minutes to run."
echo " "
bindir=@SQL_BINDIR@

if $bindir/psql -f - -d bacula $* <<END-OF-DATA

ALTER TABLE media ADD COLUMN DeviceId integer;
UPDATE media SET DeviceId=0;
ALTER TABLE media ADD COLUMN MediaTypeId integer;
UPDATE media SET MediaTypeId=0;
ALTER TABLE media ADD COLUMN LocationId integer;
UPDATE media SET LocationId=0;
ALTER TABLE media ADD COLUMN RecycleCount integer;
UPDATE media SET RecycleCount=0;
ALTER TABLE media ADD COLUMN InitialWrite timestamp without time zone;
UPDATE media SET InitialWrite=0;
ALTER TABLE media ADD COLUMN scratchpoolid integer;
UPDATE media SET scratchpoolid=0;
ALTER TABLE media ADD COLUMN recyclepoolid integer;
UPDATE media SET recyclepoolid=0;
ALTER TABLE media ADD COLUMN enabled integer;
UPDATE media SET enabled=1;

ALTER TABLE job ADD COLUMN RealEndTime timestamp without time zone;
UPDATE job SET RealEndTime=0;
ALTER TABLE job ADD COLUMN PriorJobId integer;
UPDATE job SET PriorJobId=0;

ALTER TABLE jobmedia DROP COLUMN Stripe;

CREATE TABLE Location (
   LocationId SERIAL NOT NULL,
   Location TEXT NOT NULL,
   Cost integer not null default 0,
   PRIMARY KEY (LocationId)
);

CREATE TABLE Log
(
    JobId	      serial	  not null,
    LogText	      text	  not null,
);

create index log_name_idx on Log (JobId);


DELETE FROM version;
INSERT INTO version (versionId) VALUES (10);

vacuum;

END-OF-DATA
then
   echo "Update of Bacula PostgreSQL tables succeeded."
else
   echo "Update of Bacula PostgreSQL tables failed."
fi
exit 0
