              Technical notes on version 1.39  
                        Kern Sibbald

General:

Changes to 1.39.5
06Feb06
- Implement first cut of Migration.
30Jan06
- Apply user supplied patch for more readable rate output
  in job report.
- Continue implementing migration.
- Implement support for removable filesystems in SD.
- Ensure that btraceback scripts can be read by anyone.
- Replace dvd-freespace and dvd-writepart by dvd-handler.
- Correct bug where canceling restore before the FD contacts
  the SD causes the drive to be left in read mode.
- Move ofline_or_rewind into DEVICE::close().
- Eliminate close_device.
- Convert several dev subroutines to methods (e.g. bsf,
  eod, ...)
- Eliminate force_close_device().
- Implement Device Type directive in Device resource that
  can have values File, Tape, Fifo, DVD, or Prog.
- Add has_cap() method to Device.
Changes to 1.39.4
17Jan06
- Add patch from bug #527 to allow RedHat user to specify
  options/user/group for starting each daemon in      
  /etc/sysconf/bacula.
16Jan06
- Add two new queries to query.sql provided by Arno. One
  list volumes known to the Storage device, and the other
  lists volumes possibly needing replacement (error, ...).
15Jan06
- Add periodic (every 24 hours) garbage collection of memory 
  pool by releasing free buffers.
14Jan06
- Correct bug counting sized (for display only) in smartall.c
- Print FD mempool stats if debug > 0 rather than 5.
12Jan06
- Make db_lock() mutex error fail the job rather than abort
  Bacula.  Canceling the job caused the mutex to fail.
- Correct bug in alist.c that re-allocated the list if the
  number of items goes to zero.
- Move the reservation system thread locking to the top level
  so that one job at a time tries all possible drives before
  waiting.
- Implement a reservation 'fail' message queue that is built         
  and destroyed on each pass through the reservation system.
  These messages are displayed in a 'Jobs waiting to reserve
  a drive' list during a 'status storage='.  Note, multiple
  messages will generally print for each JobId because they
  represent the different problems with either the same drive
  or different drives.  If this output proves too confusing
  of voluminous, I will display it only when debug level 1
  or greater is enabled in the SD.
11Jan06
- Add enable/disable job=<job-name>.  This command prevents
  the specified job from being scheduled. Even when disabled,
  the job can be manually started from the console.
- During 'update slots' clear all InChanger flags where the
  StorageId is zero (old Media records).

Beta release 1.38.4:
09Jan06
- Fix autochanger code to strip leading spaces from returned
  slots number. Remove bc from chio-changer.
- Back port a bit of 1.39 crypto code to reduce diffs.
- Fix first call to autochanger that missed close()ing the
  drive. Put close() just before each run_program().  Fixes
  Arno's changer bug.
07Jan06
- Add PoolId to Job record when updating it at job start time.
06Jan06
- Pull in more code from 1.39 so that there are fewer file
  differences (the new ua_dotcmds.c, base64.h, crypto.h
  hmac.c jcr.c (dird and lib) lib.h md5.h parse_conf.c 
  util.c. Aside from ua_dotcmds.c these are mostly crypto
  upgrades.
- Implement new method of walking the jcr chain. The
  incr/dec of the use_count is done within the walking
  routines.  This should prevent a jcr from being freed
  from under the walk routines.


Changes to 1.39.3:
04Jan06
- Start implementing Verify list output.
- Move the suitable_drive flag to a better place to prevent
  premature termination of the reservation if all drives
  are busy -- should fix Arno's diff/inc pool failures.
26Dec05
- Add mutex to single thread VSS code in Win32.
22Dec05
- Simplify code in askdir.c that waits for creating an appendable
  volume so that it can handle multiple returns from the wait
  code.
- Modify the wait code to permit multiple returns.
- Return a zero when "autochanger drives" is called and
  it is not an autochanger.
- Make rewind_dev() a method taking a DCR as an argument.
  This permits closing and reopening the drive if the
  rewind fails as happens if the drive was loaded while the
  file descriptor was open. This refreshes the file descriptor.
- Remove the ST_OPENED flag and always rely on fd < 0 for knowing
  if the device is open or not.  This should eliminate
  Arnos problem.
- Return error if reserve cannot find at least one suitable device.
- Make wait_for_sysop() return correct state information.
- Fix Win32 state file problem. write was not using compat
  code. This should fix bug #500.
21Dec05
- Modify gui on command to set only GUI mode and not batch.
- Modify .messages command to always print messages regardless
  of the mode.
- If GUI mode is on, suppress automatic printing of 
  You have messages. 
- Delete old bnet packet code.
- Ignore new BNET_START_SELECT and BNET_END_SELECT signals in
  wx-console.
- Modify restore command in wx-console to set gui on and to use
  only .messages instead of messages.  Hopefully this fixes bug
  #514.
- Fix seg fault in exit of acquire when canceling a job --
  reported by Wolfgang Denk
- Pull in latest reservation system changes from 1.38
- Make .messages command always print messages regardless
  of the automessages flag.
17Dec05
- Fix seg fault if user labels a drive directory bug #513
- Remove quotes around Version as it breaks things.
16Dec05
- Merge in Aleksandar Milivojevic's mods to the spec file.
- Apply sparse code fix for raw drives and fifos. Bug 506
- Thorsten fixed Unicode cd problem with wx-console bug 505.
14Dec05
- Correct reservation system to do a last ditch try
  for any mounted volume, then anyone anywhere.
- Add quotes around table Version because of
  error in MySQL 4.1.15 -- bug report submitted.
- Correct some minor problems with btape in the fill
  command.
- Updates to ssh-tunnel from Joshua Kugler.
- Added a report.pl program from Jonas Bjorklund.            
- Simplify the O_NONBLOCK open() code for tape drives,
  and always open nonblocking.
- Do not wait for open() if EIO returned (shouldn't happen).
- Eliminate 3 argument to tape open().
- Correct the slot # edited in the 3995 Bad autochanger unload
  message.
- With -S on bscan (show progress) do not divide by zero.
13Dec05
- Make cancel pthread_cond_signal() pthread_cond_broadcast().
- When dcr is freed, also broadcast dev->wait_next_vol signal.
- Remove unused code in wait_for_device.  
- Make wait_for_device() always return after 60 seconds of wait.

Changes to 1.39.2:
13Dec05
- Add stubs for non-crypto build.
12Dec05
- Use localhost if no network configured
11Dec05
- Eliminated duplicate MaxVolBytes in cat update -- bug 509.
- Remove debug print.
- Add bail_out in error during state file reading.
10Dec05
- Merge changes made to 1.38.3 into HEAD
- Add stubs for pygtk-console code
- Create Makefile.in for pygtk-console code
09Dec05
- Merge updates into 1.38 branch
- Update specs to include mysql4 define.
- Fix when attributes are sent, must be after binit().
- Stop read_record() if status not ok in second loop.
- Return rec->FileIndex in dcr->VolLastIndex for normal
  and partial records in read_record().  This allows bscan
  to get FileIndex at EOT correct.
- Fix butil.c to correctly set dcr -- fixes seg fault in bls.
08Dec05
- Fix Win32 built to work with new crypto code.
- Apply patch supplied by user (slightly modified) to fix
  correct detection of holes in block devices and FIFOs. 
  Bug # 506.
- Apply patch supplied by user (slightly modified) 
  to fix SD hang with multiple pools and bad client
  IP. Fixes bug # 508.
07Dec05
- Add nagios plugin to the examples directory. Submitted by
  Christian Masopust.
- Remove warning message about multiple saves of hardlinked files
  from find_one.c as it can generate too many warning messages.
- Modify most restore error messages to be queued so that they
  appear at the end of the job rather than mixted with the restore
  listing where they could be "lost".
06Dec05
- Reset timeout values before select() per patch from 
  Frank Sweetser for problems with non-blocking sockets.
- Unlink the state file if either reading or writing it gets
  errors.  Hopefully this will fix Win32 exit problems.
- Add sanity check in append.c to ensure that dcr is not NULL.
  This can happen if multiple drive autochanger SCSI control
  channel and drive indicies do not correspond.
05Dec05
- Get next volume from Scratch pool before creating a volume.
- Set new Pool defaults in Vol when moved from Scratch Pool.
- Remove argument from create_bacula_database for SQLite as it
  caused an error.
- Add back index code so that two drive autochangers can get
  a second tape.
- Change a bunch of debug levels to aid debugging autochangers.
- Fix reservation so that mutexes are properly applied.
- Rework reservation algorithm so that two drives can be used
  at the same time.
04Dec05
- Landon merged his data encription changes into the HEAD
- Apply days keyword patch from Alexander.Bergolth at wu-wien.ac.at 
  If this patch is applied, the number of days can be specified with
  "list nextvol days=xx"
  or
  "status dir days=xx"
  My use case is to be able to preview the next scheduled job (and the 
  next tape to be used) on fridays if there are no scheduled jobs during 
  the weekend.
Changes to 1.39.1:
03Dec05
- Fix font code in gnome2 console user patch. Fixes bug #501.
- Fix malformatted bnet error message that caused seg fault
  fixes bug 502
- Applied user patch to improve README.vc8 in src/win32.
29Nov05
- Add Migrate, Copy, Archive Job types (some where there)
- Correct some more editing of JobId's (for 64 bit compatibility).
- Ensure that StorageId is stored in Media record when ever possible.
- Add Migration Job to Job.
- Add Migration Time, Migration High Bytes, Migration Low Bytes
  Next Pool to Pool resource.
- Add more code to mac.c (migration archive copy).
- Change Start Storage daemon job to require read and write storage
  pointers.
- Pass read storage data to SD as well as write storage data.
- Remove old code from winservice.cpp
- Break on error in scan.
- Fix typo in signal.c
- Separate read/write DCR in SD.  Add jcr->read_dcr.
- Cleanup how find_device() works.
- Add read output to Status in SD.
Changes to 1.39.0:
23Nov05
- Add red-black btree routines
21Nov05
- Remove abs() in bfile.c so that it compiles on Solaris. 
  Bug #491.
20Nov05
- Fix crash in tray-monitor when daemon disconnects. Bug #479.
- Fix bnet-server bug found on OpenBSD. Bug #486
- Fix cancel failure bug. Bug #481
- Fix failure when Pool name has spaces. Bug #487   
- Fix SD crash in autochanger code. Mutex failure. Bug #488
- Fix a couple of free()s in src/filed/acl.c
- Fix memory overrun in bfile.c in building OS X resource
  fork filename. Bug #489 
- Add Pool name to SD status output.
14Nov05
- Apply SunOS patch for ACLs submitted by David Duchscher.                  
- Make sure to set storage before trying to set drive.
- Add bacula_mail_summary.sh to examples directory. It makes
  a single email summary of any number of jobs. Submitted
  by Adrew J. Millar.
- Make sure when we do a mount to unblock the device even
  if the drive could not be opened.  
13Nov05
- Remove the USE_WIN32STREAMEXTRACTION #defines (always on)
  and correct a few minor problems to make it build on Linux.
10Nov05
- Remove delete of CVS from all Makefiles
- Fix seg fault when clicking on Add button in wx-console
  restore panel.  Bug #470.
- Fix copyright date and URL typo -- bug #468.
- Change autostart install for FreeBSD to look for rc.conf  
  rather than rc.local as suggested fix for bug #466.
- Apply patch supplied by Eric Bollinger to fix PostgreSQL    
  grant on status. Bug #465
- Apply patch supplied by Eric Bollinger to fix PostgreSQL
  update script. Bug #464
- Tweak #ifdefing a bit in new Win32 stream code.
- Fix #ifdeffing for FD_NO_SEND_TEST.
- Add documentation of performance #defines
