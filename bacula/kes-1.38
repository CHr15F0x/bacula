              Technical notes on version 1.38  
                        Kern Sibbald

General:
25Mar06
- Split the bacula start/start script into four files:
   bacula         -- starts and stops calling other scripts
   bacula-ctl-dir -- starts/stops the director
   bacula-ctl-fd  -- starts/stops the File daemon
   bacula-ctl-sd  -- starts/stops the Storage daemon
24Mar06
- Create datestyle fix for PostgreSQL. Fixes bug #574.
- Correct editing of JobId from int to int64 in fd_cmds.c
- Eliminate FileSet name race with bash_spaces() and multiple
  threads by bashing in a local.
- Fix error return from 'use storage' to print a correct error
  message rather than nothing.
- Correct false re-read last block error message when two jobs 
  are simultaneously writing at the end of a tape.
- Simplify exit conditions in the reserve.c code to avoid  
  possible non-release of reservation_lock().
- Suffle lock order in reserve to avoid deadlock between
  reservation lock and device mutex.
- Add Thorsten's VSS timeout code to 1.38 branch.
21Mar06
- Initialize jcr mutex before first use. Thanks to Thorsten for
  tracking this down for me !!!! as it broke the Win32 build.
20Mar06
- Integrate addition of line count limitation to bsmtp -l from
  Sebastian Stark <stark at tuebingen.mpg.de>
17Mar06
- Implement regex test program in tools directory.
- Attempt to fix time problem with bsmtp with foreign langs.
- Add strip_trailing_newline() submitted by user.

16Mar06
- Fix bug #537 to allow arbitrary time to mount a volume for
  restore, if polling is turned on.     
- Disallow multiple storage specifications for a job. Should fix Arno's
  problem.
- Add back a missing store of poolid in jr.poolid.    
- If dir_user or dir-group is specified in ./configure apply it to
  the working-dir. Fixes bug #533.
- If rescheduling a job cancel the previous incarnation with the SD.
  Fixes bugs #566 and 557.
- Fix bug #567 do_message() definition type conflict.


14Mar06
- Add more jcr methods and make mutex and use_count private.
- Create lock/unlock methods for jcr.
- Fix PostgreSQL bug doing sql_data_seeek() by explicitly reading
  records to get to seek position.
- Integrate patch from bug #561 to correct conio.c signal definitions.
- Fix Rescheduling failed Jobs. Ensure that SD message thread 
  terminates correctly by doing pthread_kill(). Do not destroy
  SD cond wait variable between executions of the job. Use local
  mutex for cond variable to avoid blocking jcr chain. Fix poor 
  use of jcr use count in jobq.c for restarted jobs.
- Fix obsolete usage of foreach_dlist() to use foreach_jcr() in
  lib/jcr.c -- prevents locking the jcr chaing.
- Apply patch from bug #564, which corrects listing volumes with
  multiple autochangers. Apply same fix to next volume list.
- Fix bug #562 where restore bootstrap file is not unique.
- Use new routine lock_reservations() to lock the reservations
  system, and call it while looking for a volume in askdir.c.
  This could possibly fix bug #543.
- Stop SD command loop if job is canceled.

09Mar06
- Use John Kodis' edit_with_suffix code to edit VolBytes.
- Backport some fixes for acquire.c. Most importantly, to explicitly
  have a reserved_device flag for acquire_for_read().  Hopefully
  this will correct the remaining issues with failed restores holding
  a drive.
- Add a job_canceled() check in SD command loop.

Release 1.38.6 beta3 4Mar06
04Mar06
- The po files should now be current.
- Fix new sql_use_result() code to properly release the
  buffers in all cases.
- Convert to using new Python class definitons with (object).
- Use the keyword ujobid to mean the unique job id; job or jobname
  to mean the Job name given on the Name directive, and jobid to
  be the numeric (non-unique) job id.
- Allow listing by any of the above.
- Add the user friendly job report code for reporting job elapsed time
  and rates with suffexes from John Kodis <kodis at comcast.net>.
- Add Priority and JobLevel as Python settable items.
- Use TEMPORARY table creation where the table is created by
  Bacula.
- Add new code submitted by Eric for waiting on specific jobid.
- Add ACL checking for the dot commands.
- Fix restore of writable FIFOs.
- Fix a bug in bpipe where the string was freed too early.

26Feb06
- Fix bug reported by Arno listing blocks with bls
- Update the po files at Eric's request.

Release 1.38.6-beta2 25Feb06
25Feb06
- Add sql_use_result() define.

Release 1.38.6 beta1 24Feb06
24Feb06
- Don't open default catalog if not in ACL.

22Feb06
- Add virtual disk autochanger code.
- Add user supplied bug fix to make two autochangers work
  correctly using StorageId with InChanger checks.
- Correct new/old_jcr confusion in copy_storage().
- Remove & from Job during scan in msgchan.c -- probably
  trashed the stack.
- When getting the next Volume if no Volume in Append mode   
  exists and we are dealing with an Autochanger, search
  for a Scratch Volume.  
- Check for missing value in dot commands -- bug fix.
- Fix bug in update barcodes command line scanning.
- Make sure Pool Max Vols is respected.
- Check that user supplied a value before referencing
  it in restore -- pointed out by Karl Hakimian. 
- Add Karl Hakimian's table insert code.
- Don't ask user to select a specific Volume when
  updating all volumes in a Pool.
- Remove reservation if set for read when removing dcr.
- Lock code that requests next appendable volume so that
  two jobs to get the same Volume at the same time.
- Add new Device Type = xxx code. Values are file, tape,
  dvd, and fifo.
- Preserve certain modes (ST_LABEL|ST_APPEND|ST_READ) across
  a re-open to change read/write permission on a device.
- Correct a misplaced double quote in certain autochanger  
  scripts.
- Make make_catalog_backup.in a bit more portable.
- Implement Karl Hakimian's sql_use_result(), which speeds
  up restore tree building and reduces the memory load.
- Correct a number of minor bugs in getting a Volume from  
  the Scratch Pool.
- Implement additional command line options for update Volume.
- Don't require user to enter a Volume name when updating
  all Volumes in a pool.

Release 1.38.5 released 19Jan06:
19Jan06
- Apply label barcodes fix supplied by Rudolf Cejka.
18Jan06
- Modify standard rpm installation to set SD group to disk
  so that SD will by default have access to tape drives.
- Allow users to specify user/group and start options
  for each daemon in /etc/sysconf/bacula file.           

Release 1.38.4 released 17Jan06:
16Jan06
- Add two new queries to query.sql provided by Arno. One
  list volumes known to the Storage device, and the other
  lists volumes possibly needing replacement (error, ...).
15Jan06
- Add periodic (every 24 hours) garbage collection of memory 
  pool by releasing free buffers.
14Jan06
- Correct bug counting sized (for display only) in smartall.c
- Print FD mempool stats if debug > 0 rather than 5.
12Jan06
- Make db_lock() mutex error fail the job rather than abort
  Bacula.  Canceling the job caused the mutex to fail.
- Correct bug in alist.c that re-allocated the list if the
  number of items goes to zero.
- Move the reservation system thread locking to the top level
  so that one job at a time tries all possible drives before
  waiting.
- Implement a reservation 'fail' message queue that is built         
  and destroyed on each pass through the reservation system.
  These messages are displayed in a 'Jobs waiting to reserve
  a drive' list during a 'status storage='.  Note, multiple
  messages will generally print for each JobId because they
  represent the different problems with either the same drive
  or different drives.  If this output proves too confusing
  of voluminous, I will display it only when debug level 1
  or greater is enabled in the SD.
11Jan06
- Add enable/disable job=<job-name>.  This command prevents
  the specified job from being scheduled. Even when disabled,
  the job can be manually started from the console.
- During 'update slots' clear all InChanger flags where the
  StorageId is zero (old Media records).

Beta release 1.38.4:
09Jan06
- Fix autochanger code to strip leading spaces from returned
  slots number. Remove bc from chio-changer.
- Back port a bit of 1.39 crypto code to reduce diffs.
- Fix first call to autochanger that missed close()ing the
  drive. Put close() just before each run_program().  Fixes
  Arno's changer bug.
07Jan06
- Add PoolId to Job record when updating it at job start time.
06Jan06
- Pull in more code from 1.39 so that there are fewer file
  differences (the new ua_dotcmds.c, base64.h, crypto.h
  hmac.c jcr.c (dird and lib) lib.h md5.h parse_conf.c 
  util.c. Aside from ua_dotcmds.c these are mostly crypto
  upgrades.
- Implement new method of walking the jcr chain. The
  incr/dec of the use_count is done within the walking
  routines.  This should prevent a jcr from being freed
  from under the walk routines.

Release 1.38.3 05Jan06:
04Jan06
- Move the suitable_drive flag to a better place to prevent
  premature termination of the reservation if all drives
  are busy -- should fix Arno's diff/inc pool failures.
26Dec05
- Add mutex to single thread VSS code in Win32.

Beta release 23Dec05:
22Dec05
- Add OPENSSL_INC to console dependencies, lib dependencies, and
  wx-console dependencies in Makefile.in
- Add OPENSSL INC/LIB to gnome2_console Makefile.in.
- Simplify code in askdir.c that waits for creating an appendable
  volume so that it can handle multiple returns from the wait
  code.
- Modify the wait code to permit multiple returns.
- Return a zero when 'autochanger drives' is called and
  it is not an autochanger.
- Make rewind_dev() a method taking a DCR as an argument.
  This permits closing and reopening the drive if the
  rewind fails as happens if the drive was loaded while the
  file descriptor was open. This refreshes the file descriptor.
- Remove the ST_OPENED flag and always rely on fd < 0 for knowing
  if the device is open or not.  This should eliminate
  Arnos problem.
- Return error if reserve cannot find at least one suitable device.
- Make wait_for_sysop() return correct state information.
- Fix Win32 state file problem. write was not using compat
  code. This should fix bug #500.
21Dec05
- Modify gui on command to set only GUI mode and not batch.
- Modify .messages command to always print messages regardless
  of the mode.                
- If GUI mode is on, suppress automatic printing of 
  You have messages. 
- Delete old bnet packet code.
- Ignore new BNET_START_SELECT and BNET_END_SELECT signals in
  wx-console.
- Modify restore command in wx-console to set gui on and to use
  only .messages instead of messages.  Hopefully this fixes bug
  #514.
Beta release 20Dec05:
20Dec05
- Fix seg fault in exit of acquire when canceling a job --
  reported by Wolfgang Denk
19Dec05
- Implement load balancing code.
- Pull a few files from 1.39 where we can maintain compatibility.
- Rewrite reservation algorithm again. Rename variables to be
  more logical, add HEARTBEAT with Director, allow cancel of
  jobs stuck in reservation, add last resourt any_drive.
17Dec05
- Remove quotes from Version table name -- it breaks things.
- Fix seg fault if user labels a drive directly bug #513
- Remove quotes around Version as it breaks things.
16Dec05
- Merge in Aleksandar Milivojevic's mods to the spec file.
- Apply sparse code fix for raw drives and fifos. Bug 506
- Thorsten fixed Unicode cd problem with wx-console bug 505.
Beta release 14Dec05:
14Dec05
- Correct reservation system to do a last ditch try
  for any mounted volume, then anyone anywhere.
- Add quotes around table Version because of
  error in MySQL 4.1.15 -- bug report submitted.
- Correct some minor problems with btape in the fill
  command.
- Updates to ssh-tunnel from Joshua Kugler.
- Added a report.pl program from Jonas Bjorklund.            
- Simplify the O_NONBLOCK open() code for tape drives,
  and always open nonblocking.
- Do not wait for open() if EIO returned (shouldn't happen).
- Eliminate 3 argument to tape open().
- Correct the slot # edited in the 3995 Bad autochanger unload
  message.
- With -S on bscan (show progress) do not divide by zero.
  Bug #510
13Dec05
- Make cancel pthread_cond_signal() pthread_cond_broadcast().
- When dcr is freed, also broadcast dev->wait_next_vol signal.
- Remove unused code in wait_for_device.  
- Make wait_for_device() always return after 60 seconds of wait.
12Dec05
- Use localhost if no network configured
11Dec05
- Eliminated duplicate MaxVolBytes in cat update -- bug 509.
- Remove debug print.
- Add bail_out in error during state file reading.
Beta release 10Dec05:
09Dec05
- Merge updates into 1.38 branch
- Update specs to include mysql4 define.
- Stop read_record() if status not ok in second loop.
- Return rec->FileIndex in dcr->VolLastIndex for normal
  and partial records in read_record().  This allows bscan
  to get FileIndex at EOT correct.
- Fix butil.c to correctly set dcr -- fixes seg fault in bls.
08Dec05
- Apply patch supplied by user (slightly modified) to fix
  correct detection of holes in block devices and FIFOs. 
  Bug # 506.
- Apply patch supplied by user (slightly modified) 
  to fix SD hang with multiple pools and bad client
  IP. Fixes bug # 508.
07Dec05
- Add nagios plugin to the examples directory. Submitted by
  Christian Masopust.
- Remove warning message about multiple saves of hardlinked files
  from find_one.c as it can generate too many warning messages.
06Dec05
- Reset timeout values before select() per patch from 
  Frank Sweetser for problems with non-blocking sockets.
- Unlink the state file if either reading or writing it gets
  errors.  Hopefully this will fix Win32 exit problems.
- Add sanity check in append.c to ensure that dcr is not NULL.
  This can happen if multiple drive autochanger SCSI control
  channel and drive indicies do not correspond.
05Dec05
- Get next volume from Scratch pool before creating a volume.
- Set new Pool defaults in Vol when moved from Scratch Pool.
- Remove argument from create_bacula_database for SQLite as it
  caused an error.
- Add back next_vol index code so that two drive autochangers can get
  a second tape.
- Change a bunch of debug levels to aid debugging autochangers.
- Fix reservation so that mutexes are properly applied.
- Rework reservation algorithm so that two drives can be used
  at the same time.
04Dec05
- Apply days keyword patch from Alexander.Bergolth at wu-wien.ac.at 
  If this patch is applied, the number of days can be specified with
  'list nextvol days=xx'
  or
  'status dir days=xx'
  My use case is to be able to preview the next scheduled job (and the 
  next tape to be used) on fridays if there are no scheduled jobs during 
  the weekend.
03Dec05
- Fix font code in gnome2 console user patch. Fixes bug #501.
- Fix malformatted bnet error message that caused seg fault
  fixes bug 502
- Applied user patch to improve README.vc8 in src/win32.
29Nov05
- Correct some more editing of JobId's (for 64 bit compatibility).
- Ensure that StorageId is stored in Media record when ever possible.
- Add Migration Job to Job.
- Change Start Storage daemon job to require read and write storage
  pointers.
- Pass read storage data to SD as well as write storage data.
- Remove old code from winservice.cpp
- Break on error in scan.
- Fix typo in signal.c
- Separate read/write DCR in SD.  Add jcr->read_dcr.
- Cleanup how find_device() works.
- Add read output to Status in SD.
21Nov05
- Remove abs() in bfile.c so that it compiles on Solaris. 
  Bug #491.

Changes to 1.38.2: 22 November 2005
20Nov05
- Fix crash in tray-monitor when daemon disconnects. Bug #479.
- Fix bnet-server bug found on OpenBSD. Bug #486 (bug originator
  says this does not fix *his* bug).
- Fix cancel failure bug. Bug #481
- Fix failure when Pool name has spaces. Bug #487   
- Fix SD crash in autochanger code. Mutex failure. Bug #488
- Fix a couple of free()s in src/filed/acl.c
- Fix memory overrun in bfile.c in building OS X resource
  fork filename. Bug #489 
- Add Pool name to SD status output.
- Add Python install dir for Solaris to configure. Bug #492

Changes to 1.38.1: 15 November 2005
14Nov05
- Apply SunOS patch for ACLs submitted by David Duchscher.                  
- Make sure to set storage before trying to set drive.
- Add bacula_mail_summary.sh to examples directory. It makes
  a single email summary of any number of jobs. Submitted
  by Adrew J. Millar.
- Make sure when we do a mount to unblock the device even
  if the drive could not be opened.  
13Nov05
- Merge Scott's new spec files.
- Add doc on setting up Win32 environment variable supplied
  by Kees van den Broek.               
- Turn off API debug output unless debug set to avoid confusing
  the user.
- Add Solaris ACL detection in configure.in as supplied by
  Attila Fulop. 
12Nov05
- Implement 'autochanger drives' protocol so that Dir knows
  how many drives an autochanger has.
- Do not request drive number in label, ... if only one drive.
- Turn off debug code.
- Fix update slots to clear slot number of every slot before
  setting it.  This fixes (I believe) bug #471
- Make unmount unload the autochanger slot.
- Modify open() on mount to be read-only and non-blocking,      
  otherwise the mount can block for a long time.
- Make a few error message numbers unique.
- Make a few error messages more correct.
- Apply patch from Thorsten to fix Win98 stat() command.
10Nov05
- Remove delete of CVS from all makefiles.
- Fix seg fault when clicking on Add button in wx-console
  restore panel.  Bug #470.
- Fix copyright date and URL typo -- bug #468.
- Change autostart install for FreeBSD to look for rc.conf  
  rather than rc.local as suggested fix for bug #466.
- Apply patch supplied by Eric Bollinger to fix PostgreSQL    
  grant on status. Bug #465
- Apply patch supplied by Eric Bollinger to fix PostgreSQL
  update script. Bug #464
- Fix off by one for last Slot of autochanger for label.
- Update release date.
- Tweak an authentication error message in dir.
- Fix autoloader so that mutex is set and released around
  each run_program().  There was a missing set.
- Remove an unnecessary drive release in autochanger.
- Modify configure.in to add execute option to sqlite3 catalog  
  scripts.
- Create update_xxx_table_8_to_9 scripts for updatedb
- Fix wrong variable in bpipe.c debug output reported by user.
- Fix improper placement of encode_and_send_attributes() in
  FD backup.c causing first file of non-portable Win32 backup
  to have wrong stream. Reported by Thorsten.
- Move the -lcrypt for PostgreSQL after the PostgreSQL libs in
  autoconf/bacula-macros/db.m4 as suggested by user.  Fixes bug #457.
- Remove @STATIC_CONS@ from tray-monitor Makefile as suggested
  by user. Fixes bug #456.

Released 1.38.0 (28Oct05): 31 October 2005
